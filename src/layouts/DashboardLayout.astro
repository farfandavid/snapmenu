---
import { getUserById, registerUser } from "../controller/userController";
import db from "../db/db";
import { app } from "../firebase/server";
import { getAuth } from "firebase-admin/auth";

const auth = getAuth(app);

const sessionCookie = Astro.cookies.get("session")?.value;
const decodedCookie = await auth.verifySessionCookie(sessionCookie || "");
const user = await auth.getUser(decodedCookie.uid);

const userExists = await getUserById(user.uid);
console.log(userExists);
if (!userExists) {
    await registerUser(user);
}

if (!user) {
    return Astro.redirect("/login");
}
---

<!doctype html>
<html lang="en">
    <head>
        <meta charset="UTF-8" />
        <meta name="description" content="Astro description" />
        <meta name="viewport" content="width=device-width" />
        <meta name="robots" content="noindex" />
        <!-- Added noindex -->
        <link rel="icon" type="image/svg+xml" href="/favicon.svg" />
        <link
            rel="stylesheet"
            href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.min.css"
        />
        <title>{user.displayName}</title>
    </head>
    <body>
        <div
            class="h-screen grid max-md:grid-rows-12 md:grid-cols-4 xl:grid-cols-6 2xl:grid-cols-6"
        >
            <aside
                id="sidebar"
                class="bg-slate-50 text-black col-span-1 max-md:row-span-1 flex flex-col justify-between h-full"
            >
                <!-- Sidebar -->
                <div class="w-full p-0 m-0">
                    <div
                        class="bg-orange-500 h-20 flex flex-row items-center justify-between text-white px-5"
                    >
                        <div>
                            <h1 class="text-xl font-bold">
                                <span><i class="bi bi-qr-code"></i></span> SnapMenu
                            </h1>
                            <p>Welcome: {user.displayName}</p>
                        </div>
                        <button
                            id="toggleSidebar"
                            class="text-2xl rounded bg-orange-600 w-10 h-10 p-0 md:hidden"
                            type="button"><i class="bi bi-list"></i></button
                        >
                    </div>
                    <ul class="py-4 font-semibold">
                        <li
                            class="px-4 py-2 rounded-lg hover:bg-orange-600 hover:text-white"
                        >
                            <a href="/dashboard"
                                ><span
                                    ><i class="bi bi-house-door-fill mx-3"
                                    ></i></span
                                >Home</a
                            >
                        </li>
                        <li
                            class="px-4 py-2 rounded-lg hover:bg-orange-600 hover:text-white"
                        >
                            <a href="/dashboard/products"
                                ><span><i class="bi bi-box-fill mx-3"></i></span
                                >Products</a
                            >
                        </li>
                        <li
                            class="px-4 py-2 rounded-lg hover:bg-orange-600 hover:text-white"
                        >
                            <a href="/dashboard/design"
                                ><span
                                    ><i class="bi bi-palette-fill mx-3"
                                    ></i></span
                                >Designs</a
                            >
                        </li>
                        <li
                            class="px-4 py-2 rounded-lg hover:bg-orange-600 hover:text-white"
                        >
                            <a href="/dashboard/config"
                                ><span
                                    ><i class="bi bi-gear-fill mx-3"></i></span
                                >Config</a
                            >
                        </li>
                    </ul>
                </div>
                <form action="/api/auth/signout" class="w-full px-2">
                    <button
                        type="submit"
                        class="w-full rounded-lg bg-orange-500 px-5 py-2 font-medium text-white my-2 text-xl hover:bg-white hover:text-orange-500 hover:border-orange-500 border-2 border-orange-500"
                        ><span><i class="bi bi-box-arrow-in-left"></i></span
                        >Logut</button
                    >
                </form>
            </aside>
            <!-- Contenido principal -->
            <main
                id="main-content"
                class="bg-slate-100 p-4 max-md:row-span-11 md:col-span-3 xl:col-span-5 2xl:col-span-5 overflow-y-scroll"
            >
                <!-- Añade más contenido si es necesario para probar el scroll -->
                <slot />
            </main>
        </div>
    </body>
</html>
<style is:global>
    :root {
        box-sizing: border-box;
    }
    *,
    html {
        margin: 0;
        padding: 0;
        box-sizing: border-box;
    }
    body {
        margin: 0;
        padding: 0;
        box-sizing: border-box;
    }
</style>
<script>
    const $sidebar = document.getElementById("sidebar") as HTMLDivElement;
    const $mainContent = document.getElementById(
        "main-content",
    ) as HTMLDivElement;
    const $toggleSidebar = document.getElementById(
        "toggleSidebar",
    ) as HTMLButtonElement;

    $toggleSidebar.addEventListener("click", () => {
        if ($sidebar.classList.contains("max-md:row-span-1")) {
            $sidebar.classList.replace(
                "max-md:row-span-1",
                "max-md:row-span-12",
            );
            $mainContent.classList.add("hidden");
        } else {
            $sidebar.classList.replace(
                "max-md:row-span-12",
                "max-md:row-span-1",
            );
            $mainContent.classList.remove("hidden");
        }
    });
</script>
